{% extends "base.html" %}
{% block content %}
<h2>Studio: Script → HeyGen</h2>

<form method="post" id="studio-form" enctype="multipart/form-data" style="max-width: 100%">{% csrf_token %}
  <div style="display:block; width:100%;">

    <!-- UPLOAD BLOCK (full width) -->
    <div>
      <h3>Upload Spreadsheet (.xlsx)</h3>

      <div>
        <label for="id_file">Spreadsheet file (.xlsx)</label>
        <input
          type="file"
          id="id_file"
          name="file"
          accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
          style="width:100%"
        />
      </div>

      <div style="margin-top:8px">
        <label for="id_sheet">Sheet name (optional)</label>
        <input type="text" id="id_sheet" name="sheet" placeholder="Sheet1" style="width:100%" />
      </div>

      <div style="margin-top:8px">
        <label for="id_batch">Batch size (optional)</label>
        <input type="number" id="id_batch" name="batch_size" min="1" step="1" placeholder="25" value="1" style="width:100%" />
      </div>

      <button type="submit"
              id="btn-upload"
              onclick="document.getElementById('action-field').value='upload_sheet';"
              style="margin-top:12px">
        Upload & Process Sheet
      </button>

      <!-- Results: job + download -->
      <div id="upload-results" style="margin-top:12px; display:none; border:1px solid #ddd; padding:10px; border-radius:8px;">
        <div id="job-id-line" style="margin-bottom:6px;"></div>
        <a id="results-download" class="btn btn-primary" href="#" download style="display:none;">Download Processed Results</a>
        <button type="button" id="btn-load-results" style="margin-left:8px; display:none;">Load Latest Results</button>
        <div id="upload-msg" style="margin-top:8px; font-size:.9em; opacity:.8;"></div>
      </div>

      <h3 style="margin-top:16px">Recent Jobs</h3>
      <button type="button" id="btn-refresh-jobs">Refresh</button>
      <table id="jobs-table" style="width:100%; border-collapse:collapse; margin-top:8px">
        <thead>
          <tr>
            <th style="text-align:left;padding:6px">Job</th>
            <th style="text-align:left;padding:6px">State</th>
            <th style="text-align:left;padding:6px">Mode</th>
            <th style="text-align:left;padding:6px">Created</th>
            <th style="text-align:left;padding:6px">Actions</th>
          </tr>
        </thead>
        <tbody id="jobs-body"></tbody>
      </table>
    </div>

  </div>

  <!-- Hidden action field -->
  <input type="hidden" name="action" id="action-field" value="">
</form>

<!-- Preview table -->
<div id="results-wrap" style="margin-top:16px; display:none;">
  <h3 style="margin-top:24px">Processed Rows Preview</h3>
  <table id="results-table" style="width:100%; border-collapse:collapse;">
    <thead><tr id="results-head"></tr></thead>
    <tbody id="results-body"></tbody>
  </table>
</div>

<script>
  const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value || "";

  // Elements
  const formEl     = document.getElementById("studio-form");
  const actionFld  = document.getElementById("action-field");
  const uploadBtn  = document.getElementById("btn-upload");
  const resultsBox = document.getElementById("upload-results");
  const jobLine    = document.getElementById("job-id-line");
  const dlBtn      = document.getElementById("results-download");
  const loadBtn    = document.getElementById("btn-load-results");
  const msgBox     = document.getElementById("upload-msg");

  // Preview helpers
  let currentJobId = null;

  function renderTable(headers, rows){
    const head = document.getElementById("results-head");
    const body = document.getElementById("results-body");
    const wrap = document.getElementById("results-wrap");
    head.innerHTML = ""; body.innerHTML = "";

    (headers || []).forEach(h=>{
      const th = document.createElement("th");
      th.textContent = (h || "").toString();
      th.style.textAlign = "left";
      th.style.padding = "8px";
      head.appendChild(th);
    });

    (rows || []).forEach(r=>{
      const tr = document.createElement("tr");
      (headers || []).forEach(h=>{
        const td = document.createElement("td");
        td.textContent = (r?.[h] ?? "").toString();
        td.style.padding = "8px";
        td.style.borderTop = "1px solid #eee";
        tr.appendChild(td);
      });
      body.appendChild(tr);
    });

    if (wrap) wrap.style.display = "block";
  }

  async function fetchAndRenderResults(jobId){
    if(!jobId) return;
    try{
      if(loadBtn){ loadBtn.disabled = true; loadBtn.textContent = "Loading…"; }
      const r = await fetch(`/api/jobs/${jobId}/results/?limit=200`, {cache:"no-store"});
      if(!r.ok){
        msgBox.textContent = "Results not ready yet. Try again.";
        return;
      }
      const j = await r.json();

      if (j.download_url){
        dlBtn.href = j.download_url;
        dlBtn.style.display = "inline-block";
      }

      renderTable(j.headers || [], j.rows || []);
      msgBox.textContent = (j.rows || []).length ? `Loaded ${j.count} row(s).` : "No rows yet—click Load Latest Results again in a bit.";
    } catch(e){
      msgBox.textContent = "Error loading results.";
    } finally{
      if(loadBtn){ loadBtn.disabled = false; loadBtn.textContent = "Load Latest Results"; }
    }
  }

  if (loadBtn){
    loadBtn.addEventListener("click", ()=> fetchAndRenderResults(currentJobId));
  }

  // Poll status endpoint until SUCCESS/FAILURE
  async function pollJob(statusUrl) {
    if (!statusUrl) return;
    let tries = 0;
    const maxTries = 1800; // ~1 hour at 2s
    const t = setInterval(async () => {
      tries++;
      try {
        const r = await fetch(statusUrl, { cache: "no-store" });
        const st = await r.json();

        if (jobLine) jobLine.textContent = st?.job_id ? `Job: ${st.job_id} — ${st.state}` : `Status: ${st.state}`;

        if (st.state === "SUCCESS") {
          clearInterval(t);
          if (st.download_url) {
            dlBtn.href = st.download_url;
            dlBtn.style.display = "inline-block";
          }
          msgBox.textContent = "Done. Download ready.";
          fetchAndRenderResults(currentJobId);
        } else if (st.state === "FAILURE") {
          clearInterval(t);
          msgBox.textContent = st.error || "Job failed.";
        } else if (["STARTED","PROGRESS","RUNNING","RECEIVED"].includes(st.state)) {
          msgBox.textContent = "Processing…";
        } else if (st.state === "PENDING") {
          msgBox.textContent = "Queued…";
        }

        if (tries >= maxTries) {
          clearInterval(t);
          msgBox.textContent = "Timed out waiting for job.";
        }
      } catch (e) {
        if (tries >= maxTries) {
          clearInterval(t);
          msgBox.textContent = "Polling error.";
        }
      }
    }, 2000);
  }

  // Recent Jobs
  async function loadJobs(){
    try{
      const r = await fetch("/api/jobs/?limit=25", {cache:"no-store"});
      const j = await r.json();
      const body = document.getElementById("jobs-body");
      body.innerHTML = "";
      (j.jobs || []).forEach(job=>{
        const tr = document.createElement("tr");
        const state = job.state || "QUEUED";

        const tdJob = `<td style="padding:6px; border-top:1px solid #eee; font-family:monospace">${job.job_id}</td>`;
        const badgeColor = state === "SUCCESS" ? "#16a34a" : state === "FAILURE" ? "#dc2626" : "#2563eb";
        const tdState = `<td style="padding:6px; border-top:1px solid #eee;"><span style="display:inline-block;padding:2px 8px;border-radius:999px;background:${badgeColor};color:#fff;font-size:12px">${state}</span></td>`;
        const tdMode = `<td style="padding:6px; border-top:1px solid #eee;">${job.mode || ""}</td>`;
        const tdCreated = `<td style="padding:6px; border-top:1px solid #eee;">${(job.created_at||"").replace("T"," ").slice(0,19)}</td>`;

        const viewBtn = `<button type="button" class="btn btn-sm" onclick="fetchAndRenderResults('${job.job_id}')">View</button>`;
        const dlBtnHtml = job.download_url ? `<a href="${job.download_url}" class="btn" style="margin-right:8px">Download</a>` : "";
        const tdActions = `<td style="padding:6px; border-top:1px solid #eee;">${dlBtnHtml}${viewBtn}</td>`;

        tr.innerHTML = tdJob+tdState+tdMode+tdCreated+tdActions;
        body.appendChild(tr);
      });
    } catch(e){
      // ignore
    }
  }
  document.getElementById("btn-refresh-jobs")?.addEventListener("click", loadJobs);
  document.addEventListener("DOMContentLoaded", loadJobs);

  // Submit handler for file upload
  if (formEl) {
    formEl.addEventListener("submit", async (e) => {
      if (!actionFld || actionFld.value !== "upload_sheet") return; // only intercept for upload
      e.preventDefault();

      const fd = new FormData(formEl); // file, sheet, batch_size, csrf, action
      try {
        uploadBtn.disabled = true;
        uploadBtn.textContent = "Uploading…";

        const r = await fetch("/api/v1/paragraph", {
          method: "POST",
          headers: { "X-CSRFToken": csrf },
          body: fd
        });
        const j = await r.json();

        resultsBox.style.display = "block";
        dlBtn.style.display = "none";
        msgBox.textContent = "";
        jobLine.textContent = j.job_id ? `Job: ${j.job_id}` : "";

        if (!r.ok) {
          msgBox.textContent = j.error || "Upload failed.";
          return;
        }

        currentJobId = j.job_id || null;
        if (loadBtn) loadBtn.style.display = currentJobId ? "inline-block" : "none";

        if (j.download_url) {
          dlBtn.href = j.download_url;
          dlBtn.style.display = "inline-block";
          msgBox.textContent = "Done. Download ready.";
          fetchAndRenderResults(currentJobId);
        } else {
          const statusUrl = j.status_url || (j.job_id ? `/api/jobs/${j.job_id}/status/` : null);
          msgBox.textContent = statusUrl ? "Queued. Processing…" : "Queued.";
          if (statusUrl) pollJob(statusUrl);
        }
      } catch (err) {
        resultsBox.style.display = "block";
        dlBtn.style.display = "none";
        msgBox.textContent = "Upload error.";
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Upload & Process Sheet";
        if (actionFld) actionFld.value = "";
      }
    });
  }
</script>
{% endblock %}
