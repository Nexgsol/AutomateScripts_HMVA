{% extends "base.html" %}
{% block content %}
<h2>Studio: Script → HeyGen</h2>

<form method="post" id="studio-form">{% csrf_token %}
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items:start;">

    <!-- LEFT COLUMN -->
    <div>
      <h3>1) Icon & Paragraph</h3>

      <div>
        <label>{{ form.brand.label }}</label>
        {{ form.brand }}
      </div>

      <div style="margin-top:8px">
        <label>{{ form.icon.label }}</label>
        {{ form.icon }}
      </div>

      <div style="margin-top:8px">
        <label>{{ form.category.label }}</label>
        {{ form.category }}
      </div>

      <div style="margin-top:8px">
        <label>{{ form.notes.label }}</label>
        {{ form.notes }}
      </div>

      <div style="margin-top:8px">
        <label>{{ form.duration.label }}</label>
        {{ form.duration }}
      </div>

      <button type="button" id="btn-generate" style="margin-top:12px">Generate Paragraph</button>

      <h4 style="margin-top:16px">Paragraph Preview</h4>
      <textarea id="paragraph" rows="10" style="width:100%" readonly>{{ paragraph }}</textarea>

      <h4 style="margin-top:16px">SSML Output</h4>
      <textarea id="ssml-output" rows="10" style="width:100%" readonly>{{ ssml }}</textarea>
    </div>

    <!-- RIGHT COLUMN -->
    <div>
      <h3>2) Pick Avatar & Voice</h3>

      <div>
        <label>HeyGen Avatar</label>
        <select id="heygen-avatar-select">
          <option value="">Loading…</option>
        </select>
        <input type="hidden" name="heygen_avatar_id" id="id_heygen_avatar_id"/>
      </div>

      <div style="margin-top:12px">
        <label>HeyGen Voice (optional)</label>
        <select id="heygen-voice-select">
          <option value="">Loading…</option>
        </select>
        <input type="hidden" name="heygen_voice_id" id="id_heygen_voice_id"/>
      </div>

      <div style="margin-top:12px">
        <label>ElevenLabs Voice ID (for audio)</label>
        <input type="text" id="eleven-voice-id" placeholder="e.g. 21m00Tcm4TlvDq8ikWAM" style="width:100%">
      </div>

      <button type="button" id="btn-voice" style="margin-top:12px">
        Generate Voice (ElevenLabs)
      </button>

      <audio id="voice-audio" controls style="display:none; width:100%; margin-top:8px;"></audio>
      <a id="voice-download" href="#" download="voice.mp3" style="display:none; margin-top:6px; display:inline-block;">
        Download Audio
      </a>

      <input type="hidden" name="action" id="action-field" value="">
      <input type="hidden" name="audio_url" id="id_audio_url">

      <button type="submit"
              onclick="document.getElementById('action-field').value='generate_video';"
              style="margin-top:16px">
        Create Video
      </button>
    </div>
  </div>
</form>


<script>
  const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Auto-fill category/notes on icon change
  const iconSelect = document.getElementById("id_icon");
  const catInput = document.getElementById("id_category");
  const notesInput = document.getElementById("id_notes");

  async function refreshIconMeta(){
    const id = iconSelect.value;
    if(!id){ catInput.value=""; notesInput.value=""; return; }
    const r = await fetch(`/api/icons/${id}/meta`);
    const j = await r.json();
    catInput.value = j.category || "";
    notesInput.value = j.notes || "";
  }
  if (iconSelect) {
    iconSelect.addEventListener("change", refreshIconMeta);
    refreshIconMeta();
  }

  // Generate paragraph via API
  const btnGen = document.getElementById("btn-generate");
  const paraBox = document.getElementById("paragraph");
  const ssmlBox = document.getElementById("ssml-output");
  const durationInput = document.getElementById("id_duration");

  btnGen.addEventListener("click", async () => {
    const iconText = iconSelect.options[iconSelect.selectedIndex]?.text || "";
    const notes = notesInput.value || "";
    const duration = durationInput.value || "";
    const r = await fetch("/api/v1/paragraph", {
      method:"POST",
      headers: {"Content-Type":"application/json", "X-CSRFToken": csrf},
      body: JSON.stringify({icon: iconText, notes: notes, duration: duration})
    });
    const j = await r.json();
    paraBox.value = j.data.paragraph || "";
    ssmlBox.value = j.data.ssml || "";
  });

  // ElevenLabs TTS (AJAX -> backend -> returns audio_url)
  const btnVoice = document.getElementById('btn-voice');
  const elevenVoiceInput = document.getElementById('eleven-voice-id');
  const audioEl = document.getElementById('voice-audio');
  const dlLink = document.getElementById('voice-download');
  const heygenVoiceSelect = document.getElementById("heygen-voice-select");
  const heygenVoiceHidden = document.getElementById("id_heygen_voice_id");
  const hidAudio = document.getElementById('id_audio_url');

  // When HeyGen voice changes → update both hidden field + ElevenLabs input
  heygenVoiceSelect.addEventListener("change", () => {
    const val = heygenVoiceSelect.value;
    heygenVoiceHidden.value = val;
    elevenVoiceInput.value  = val;  // auto-fill
  });

  btnVoice.addEventListener('click', async () => {
    const voiceId = (elevenVoiceInput.value || '').trim();
    const ssml = (ssmlBox.value || '').trim();
    if (!voiceId) { alert('Please enter an ElevenLabs Voice ID.'); return; }
    if (!ssml) { alert('SSML is empty. Generate the paragraph first.'); return; }

    btnVoice.disabled = true;
    const prev = btnVoice.textContent;
    btnVoice.textContent = 'Generating voice…';

    try {
      const fd = new FormData();
      fd.append('voice_id', voiceId);
      fd.append('ssml', ssml);

      const r = await fetch("{% url 'api-tts-elevenlabs' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': csrf},
        body: fd
      });
      const j = await r.json();
      if (j.audio_url) {
        audioEl.src = j.audio_url;
        audioEl.style.display = 'block';
        audioEl.load();
        dlLink.href = j.audio_url;
        dlLink.style.display = 'inline-block';
        hidAudio.value = new URL(j.audio_url, window.location.origin).href;
      } else {
        alert(j.error || 'Failed to generate audio.');
      }
    } catch (e) {
      alert('Error generating audio.');
    } finally {
      btnVoice.disabled = false;
      btnVoice.textContent = prev;
    }
  });

  // Populate HeyGen avatars/voices
  const avSel = document.getElementById("heygen-avatar-select");
  const voSel = document.getElementById("heygen-voice-select");
  const avHidden = document.getElementById("id_heygen_avatar_id");
  const voHidden = document.getElementById("id_heygen_voice_id");

  function setSelOptions(sel, items, idKey, nameKey){
    sel.innerHTML = '<option value="">Select…</option>';
    items.forEach(it=>{
      const opt = document.createElement("option");
      opt.value = it[idKey] || it["id"] || it["avatar_id"] || "";
      opt.textContent = it[nameKey] || it["name"] || opt.value;
      sel.appendChild(opt);
    });
  }
  async function loadHeygen(){
    try{
      const a = await (await fetch("/api/heygen/avatars")).json();
      setSelOptions(avSel, a.avatars || [], "id", "name");
    }catch(e){ avSel.innerHTML = '<option value="">(no avatars)</option>'; }
    try{
      const v = await (await fetch("/api/heygen/voices")).json();
      setSelOptions(voSel, v.voices || [], "id", "name");
    }catch(e){ voSel.innerHTML = '<option value="">(no voices)</option>'; }
  }
  avSel.addEventListener("change", ()=> avHidden.value = avSel.value);
  voSel.addEventListener("change", ()=> voHidden.value = voSel.value);
  loadHeygen();
</script>
{% endblock %}
